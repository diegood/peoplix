// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Project {
  id              String @id @default(uuid())
  name            String
  contractedHours Int

  allocations   Allocation[]
  milestones    Milestone[]
  sprints       Sprint[]
  requiredRoles ProjectRequirement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Collaborator {
  id              String   @id @default(uuid())
  userName        String?  @unique
  firstName       String   @default("")
  lastName        String   @default("")
  name            String? // Deprecated, kept for migration
  contractedHours Int
  joinDate        DateTime @default(now())
  isActive        Boolean  @default(true)

  allocations       Allocation[]
  skills            CollaboratorSkill[]
  roles             CollaboratorRole[]
  hardware          Hardware[]
  holidayCalendar   HolidayCalendar?
  customFieldValues CustomFieldValue[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Role {
  id   String @id @default(uuid())
  name String @unique

  collaborators CollaboratorRole[]
  allocations   AllocationRole[]
  requirements  ProjectRequirement[]
}

model Skill {
  id   String @id @default(uuid())
  name String @unique

  collaborators CollaboratorSkill[]
  requirements  RequirementSkill[]
}

model Allocation {
  id                   String  @id @default(uuid())
  dedicationPercentage Int
  startWeek            String
  endWeek              String?

  projectId      String
  project        Project      @relation(fields: [projectId], references: [id])
  collaboratorId String
  collaborator   Collaborator @relation(fields: [collaboratorId], references: [id], onDelete: Cascade)

  roles AllocationRole[]

  subordinatesHierarchy AllocationHierarchy[] @relation("AllocationSupervisor")
  supervisorsHierarchy  AllocationHierarchy[] @relation("AllocationSubordinate")
}

model AllocationHierarchy {
  id String @id @default(uuid())

  subordinateId String
  subordinate   Allocation @relation("AllocationSubordinate", fields: [subordinateId], references: [id], onDelete: Cascade)

  supervisorId String
  supervisor   Allocation @relation("AllocationSupervisor", fields: [supervisorId], references: [id], onDelete: Cascade)

  hierarchyTypeId String
  hierarchyType   HierarchyType @relation(fields: [hierarchyTypeId], references: [id])

  @@unique([subordinateId, hierarchyTypeId])
}

model HierarchyType {
  id    String @id @default(uuid())
  name  String @unique
  color String @default("bg-gray-100 text-gray-700 border-gray-200")
  rank  Int    @default(0)

  hierarchies AllocationHierarchy[]
}

model AllocationRole {
  id           String     @id @default(uuid())
  allocationId String
  allocation   Allocation @relation(fields: [allocationId], references: [id], onDelete: Cascade)
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id])

  @@unique([allocationId, roleId])
}

model Milestone {
  id   String @id @default(uuid())
  name String
  date String // ISO Date string

  // Legacy string field (optional during migration)
  type String?

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  milestoneTypeId String?
  milestoneType   MilestoneType? @relation(fields: [milestoneTypeId], references: [id])
}

model MilestoneType {
  id    String @id @default(uuid())
  name  String @unique
  color String @default("bg-gray-400")

  milestones Milestone[]
}

model Sprint {
  id        String @id @default(uuid())
  name      String
  startDate String
  endDate   String

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model ProjectRequirement {
  id            String @id @default(uuid())
  resourceCount Int    @default(1)
  monthlyHours  Int    @default(160)

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  roleId    String
  role      Role    @relation(fields: [roleId], references: [id])

  skills RequirementSkill[]
}

model RequirementSkill {
  id    String @id @default(uuid())
  level Int

  requirementId String
  requirement   ProjectRequirement @relation(fields: [requirementId], references: [id], onDelete: Cascade)
  skillId       String
  skill         Skill              @relation(fields: [skillId], references: [id])
}

model CollaboratorSkill {
  id    String @id @default(uuid())
  level Int

  collaboratorId String
  collaborator   Collaborator @relation(fields: [collaboratorId], references: [id], onDelete: Cascade)
  skillId        String
  skill          Skill        @relation(fields: [skillId], references: [id])

  @@unique([collaboratorId, skillId])
}

model CollaboratorRole {
  id String @id @default(uuid())

  collaboratorId String
  collaborator   Collaborator @relation(fields: [collaboratorId], references: [id], onDelete: Cascade)
  roleId         String
  role           Role         @relation(fields: [roleId], references: [id])

  @@unique([collaboratorId, roleId])
}

model Technology {
  id   String @id @default(uuid())
  name String @unique
}

model Hardware {
  id           String   @id @default(uuid())
  name         String
  type         String // e.g., "Laptop", "Monitor", "Phone"
  serialNumber String?
  assignedDate DateTime @default(now())

  collaboratorId String
  collaborator   Collaborator @relation(fields: [collaboratorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model HolidayCalendar {
  id           String   @id @default(uuid())
  year         Int
  holidays     String // JSON array of holiday dates
  lastModified DateTime @updatedAt

  collaboratorId String       @unique
  collaborator   Collaborator @relation(fields: [collaboratorId], references: [id], onDelete: Cascade)

  @@unique([collaboratorId, year])
}

model CustomFieldDefinition {
  id          String  @id @default(uuid())
  fieldName   String  @unique
  fieldLabel  String
  fieldType   String // "text", "number", "date", "select", "textarea", "checkbox", "radio"
  fieldConfig String // JSON for FormKit schema (options, validation, etc.)
  isRequired  Boolean @default(false)
  order       Int     @default(0)

  values CustomFieldValue[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CustomFieldValue {
  id    String @id @default(uuid())
  value String // JSON value

  collaboratorId String
  collaborator   Collaborator @relation(fields: [collaboratorId], references: [id], onDelete: Cascade)

  fieldDefinitionId String
  fieldDefinition   CustomFieldDefinition @relation(fields: [fieldDefinitionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([collaboratorId, fieldDefinitionId])
}
